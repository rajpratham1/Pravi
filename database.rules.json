{
  "rules": {
    "users": {
      ".read": "root.child('users').child(auth.uid).child('role').val() === 'admin'",
      ".indexOn": ["role"],
      "$uid": {
        ".read": "$uid === auth.uid || root.child('users').child(auth.uid).child('role').val() === 'admin'",
        ".write": "$uid === auth.uid",
        ".validate": "newData.hasChildren(['role', 'email', 'createdAt'])"
      }
    },
    "approvedEmails": {
      ".read": true,
      ".write": "root.child('users').child(auth.uid).child('role').val() === 'admin'"
    },
    "applicantEmails": {
      ".read": "root.child('users').child(auth.uid).child('role').val() === 'admin'",
      "$email": {
          // Allow anyone to check for the existence of a specific email.
          ".read": true,
          // Allow an unauthenticated user to add an email if it doesn't exist yet.
          ".write": "!data.exists() && auth != null"
      }
    },
    "applications": {
      // Admins can read the list.
      ".read": "root.child('users').child(auth.uid).child('role').val() === 'admin'",
      // Logged-in users can attempt to write.
      ".write": "auth != null",
      ".indexOn": ["status"],
      "$applicationId": {
        // When creating a new application (!data.exists()), the applicant must be the one writing it, and status must be 'pending'.
        // When updating an existing application (data.exists()), the user must be an admin.
        ".validate": "newData.hasChildren(['applicantId', 'name', 'email', 'phone', 'bankAccount', 'ifscCode', 'holderName', 'aadhaarData', 'panData', 'status', 'appliedAt']) && ( (!data.exists() && newData.child('applicantId').val() === auth.uid && newData.child('status').val() === 'pending') || (data.exists() && root.child('users').child(auth.uid).child('role').val() === 'admin') )"
      }
    },
    "listings": {
      ".read": true,
      ".indexOn": ["userId", "createdAt"],
      "$listingId": {
        ".write": "((!data.exists() && newData.child('userId').val() === auth.uid) || (data.exists() && data.child('userId').val() === auth.uid) || root.child('users').child(auth.uid).child('role').val() === 'admin')",
        ".validate": "newData.hasChildren(['title', 'description', 'price', 'websiteURL', 'userId', 'createdAt'])"
      }
    },
    "inquiries": {
      ".read": "auth != null",
      ".indexOn": ["buyerId", "sellerId"],
      "$inquiryId": {
        ".read": "data.child('buyerId').val() === auth.uid || data.child('sellerId').val() === auth.uid || root.child('users').child(auth.uid).child('role').val() === 'admin'",
        ".write": "auth != null && newData.child('buyerId').val() === auth.uid",
        ".validate": "newData.hasChildren(['listingId', 'listingTitle', 'sellerId', 'buyerId', 'message', 'createdAt'])"
      }
    },
    "orders": {
      ".read": "root.child('users').child(auth.uid).child('role').val() === 'admin'",
      ".write": "auth != null",
      ".indexOn": ["userId"],
      "$orderId": {
        ".read": "data.child('userId').val() === auth.uid || root.child('users').child(auth.uid).child('role').val() === 'admin'",
        ".write": "(!data.exists() && newData.child('userId').val() === auth.uid) || (data.exists() && root.child('users').child(auth.uid).child('role').val() === 'admin')",
        ".validate": "newData.hasChildren(['userId', 'items', 'total', 'status', 'createdAt'])"
      }
    }
  }
}
